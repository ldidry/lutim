image: hatsoftwares/test-ci:latest
stages:
  - sqlite
  - postgresql
before_script:
  - carton install
  - apt-get install -y shared-mime-info sudo
  - rm -f *db
sqlite:
  stage: sqlite
  cache:
    key: "$CI_BUILD_REF_NAME"
    untracked: true
    paths:
      - local
  script:
    - make podcheck
    - service postgresql restart
    - sleep 10
    - service postgresql status
    - make create-pg-test-db
    - MOJO_CONFIG=t/sqlite2.conf make minion &
    - MOJO_CONFIG=t/sqlite3.conf make minion &
    - MOJO_CONFIG=t/sqlite1.conf make test-sqlite
    - MOJO_CONFIG=t/sqlite1.conf make watch -m production
    - MOJO_CONFIG=t/sqlite1.conf make cleanbdd -m production
    - MOJO_CONFIG=t/sqlite1.conf make cleanfiles -m production
    - MOJO_CONFIG=t/sqlite1.conf make stats -m production
    - MOJO_CONFIG=t/sqlite2.conf make test-sqlite
    - MOJO_CONFIG=t/sqlite2.conf make watch -m production
    - MOJO_CONFIG=t/sqlite2.conf make cleanbdd -m production
    - MOJO_CONFIG=t/sqlite2.conf make cleanfiles -m production
    - MOJO_CONFIG=t/sqlite2.conf make stats -m production
    - MOJO_CONFIG=t/sqlite3.conf make test-sqlite
    - MOJO_CONFIG=t/sqlite3.conf make watch -m production
    - MOJO_CONFIG=t/sqlite3.conf make cleanbdd -m production
    - MOJO_CONFIG=t/sqlite3.conf make cleanfiles -m production
    - MOJO_CONFIG=t/sqlite3.conf make stats -m production
  tags:
    - Debian
    - Jessie
postgresql:
  stage: postgresql
  cache:
    key: "$CI_BUILD_REF_NAME"
    untracked: true
    paths:
      - local
  script:
    - make podcheck
    - service postgresql restart
    - sleep 10
    - service postgresql status
    - make create-pg-test-db
    - MOJO_CONFIG=t/postgresql2.conf make minion &
    - MOJO_CONFIG=t/postgresql3.conf make minion &
    - MOJO_CONFIG=t/postgresql1.conf make test-pg
    - MOJO_CONFIG=t/postgresql1.conf make watch -m production
    - MOJO_CONFIG=t/postgresql1.conf make cleanbdd -m production
    - MOJO_CONFIG=t/postgresql1.conf make cleanfiles -m production
    - MOJO_CONFIG=t/postgresql1.conf make stats -m production
    - MOJO_CONFIG=t/postgresql2.conf make test-pg
    - MOJO_CONFIG=t/postgresql2.conf make watch -m production
    - MOJO_CONFIG=t/postgresql2.conf make cleanbdd -m production
    - MOJO_CONFIG=t/postgresql2.conf make cleanfiles -m production
    - MOJO_CONFIG=t/postgresql2.conf make stats -m production
    - MOJO_CONFIG=t/postgresql3.conf make test-pg
    - MOJO_CONFIG=t/postgresql3.conf make watch -m production
    - MOJO_CONFIG=t/postgresql3.conf make cleanbdd -m production
    - MOJO_CONFIG=t/postgresql3.conf make cleanfiles -m production
    - MOJO_CONFIG=t/postgresql3.conf make stats -m production
  tags:
    - Debian
    - Jessie
